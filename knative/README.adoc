# Test serverless/kafka source infratructure
TODO: table of contents

## Prerequisites

- Install OpenShift Serverless - Knative Serving
- Install Camel K Operator

## create cluster and topic
```
oc new-project scm-test
sh oc apply -f ../kafka/
```

## publish knative camel service

```
kamel run ScmEchoService.java --dev --name scm-echo -d camel-rest --trait knative-service.enabled=true #dev mode, with live coding
# kamel run ScmEchoService.java --name scm-echo -d camel-rest --trait knative-service.enabled=true 
```
If this is the first time run, it may take a while to deploy. To check status run if you didn't do `kamel run` in dev mode
```
kamel get scm-echo
```

## Install the Kafka Source
### Instructions for CamelK Kafka Source (Preferred)

first install kamelet for insecure kafka sources
```
oc apply -f https://raw.githubusercontent.com/apache/camel-kamelets/main/kamelets/kafka-not-secured-source.kamelet.yaml 
```

publish kafka source
```
oc appy -f kafka-source-kamelet.yaml
```

### alternate Instructions for Knative Kafka Souce

Make sure Knative-eventing and  Knative-Kafka are installed in the OpenShift Serverless Operator. Whenconfiguring KnativeKafka, only the source needs to be enabled. For e.g.
```yaml
apiVersion: operator.serverless.openshift.io/v1alpha1
kind: KnativeKafka
metadata:
    name: knative-kafka
    namespace: knative-eventing
spec:
    channel:
        enabled: false
    source:
        enabled: true 
```

Modify the kakfa source to update the namespace name

```
TODO: some sed
oc apply -f kafka-source-knative.yaml
```

## instructions to test

### Quick test
```
oc -n kafka run kafka-producer \
    -ti --image=quay.io/strimzi/kafka:latest-kafka-2.7.0 --rm=true \
    --restart=Never -- bin/kafka-console-producer.sh \
    --broker-list scm-cluster-kafka-brokers:9092 --topic scm-file-topic

```

### Autoscale Test

```
oc run kafka-spammer -it --image=jonnyman9/kafka-python-spammer:latest --rm=true --restart=Never --env KAFKA_BOOTSTRAP_HOST=scm-cluster-kafka-brokers --env TOPIC_NAME=scm-file-topic --env TIMES=100
```