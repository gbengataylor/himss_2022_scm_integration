# Test serverless/kafka source infratructure
TODO: table of contents

## Prerequisites

- Install OpenShift Serverless - Knative Serving
- Install Camel K 

## create cluster and topic
```
oc new-project scm-test
sh oc apply -f ../kafka/
```

## publish knative camel service

```
kamel run ScmEchoService.java --dev --name scm-echo -d camel-rest --trait knative-service.enabled=true
```

## Install the Kafka Source
### Instructions for CamelK Kafka Source (Preferred)

first install kamelet for insecure kafka sources
```
oc apply -f https://raw.githubusercontent.com/apache/camel-kamelets/main/kamelets/kafka-not-secured-source.kamelet.yaml 
```

publish kafka source
```
oc appy -f kafka-source-kamelet.yaml
```

### alternate Instructions for Knative Kafka Souce

Make sure Knative Kafka is installed. Only the source needs to be enabled
```yaml
apiVersion: operator.serverless.openshift.io/v1alpha1
kind: KnativeKafka
metadata:
    name: knative-kafka
    namespace: knative-eventing
spec:
    channel:
        enabled: false
    source:
        enabled: true 
```

Modify the kakfa source to update the namespace name

```
TODO: some sed
oc apply -f kafka-source-knative.yaml
```

## instructions to test

### Quick test
```
oc -n kafka run kafka-producer \
    -ti --image=quay.io/strimzi/kafka:latest-kafka-2.7.0 --rm=true \
    --restart=Never -- bin/kafka-console-producer.sh \
    --broker-list scm-cluster-kafka-brokers:9092:9092 --topic scm-file-topic

```

### Autoscale Test

run spammer